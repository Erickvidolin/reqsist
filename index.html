<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Requisição de Materiais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA2FvtO-b74SSPPCTPLXuNJdE8j_URIL-E",
            authDomain: "sistema-requisicao-df38d.firebaseapp.com",
            projectId: "sistema-requisicao-df38d",
            storageBucket: "sistema-requisicao-df38d.firebasestorage.app",
            messagingSenderId: "302372688890",
            appId: "1:302372688890:web:b1eae19b67c2e814108a43"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Configurar para evitar redirecionamento automático
        auth.setPersistence('session').catch((error) => {
            console.error('Erro ao configurar persistência:', error);
        });

        // Exportar para uso global
        window.firebase = {
            db,
            auth,
            collection,
            addDoc,
            getDocs,
            updateDoc,
            doc,
            onSnapshot,
            query,
            where,
            orderBy,
            serverTimestamp,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        };

        console.log('Firebase inicializado com sucesso!');
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#8b5cf6'
                    }
                }
            }
        }
    </script>
    <style>
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .table-row:hover {
            background-color: #f8fafc;
        }
        
        /* Loading spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Melhorias para mobile */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            
            .mobile-p-2 {
                padding: 0.5rem;
            }
        }
        
        /* Estilo para tabela responsiva */
        .responsive-table {
            min-width: 800px;
        }
        
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
            }
            
            .mobile-w-full {
                width: 100%;
            }
            
            .mobile-mb-2 {
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl card-shadow p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-boxes text-5xl text-primary mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">Sistema de Requisição</h1>
                <p class="text-gray-600 mt-2">Faça login para continuar</p>
            </div>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-medium mb-2">E-mail</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="seu@email.com" required>
                </div>
                
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 text-sm font-medium mb-2">Senha</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="Digite sua senha" required>
                </div>
                
                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-secondary transition duration-200 font-medium">
                    Entrar
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                <p></p>
            </div>
        </div>
    </div>

    <!-- Tela Principal (após login) -->
    <div id="main-screen" class="hidden min-h-screen">
        <!-- Cabeçalho -->
        <header class="bg-white card-shadow">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center">
                    <i class="fas fa-boxes text-2xl text-primary mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-800">Sistema de Requisição</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="user-info" class="text-gray-700"></span>
                    <button id="logout-btn" class="bg-gray-200 text-gray-700 py-1 px-3 rounded-lg hover:bg-gray-300 transition duration-200">
                        <i class="fas fa-sign-out-alt mr-1"></i> Sair
                    </button>
                </div>
            </div>
            
            <!-- Navegação -->
            <nav class="bg-secondary">
                <div class="container mx-auto px-4">
                    <ul class="flex">
                        <li>
                            <a href="#" id="nav-requisicao" class="nav-link active text-white py-3 px-4 md:px-6 block font-medium text-sm md:text-base">
                                <i class="fas fa-plus-circle mr-2"></i> <span class="hidden sm:inline">Nova</span> Requisição
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-atendimento" class="nav-link text-white py-3 px-4 md:px-6 block font-medium text-sm md:text-base">
                                <i class="fas fa-tasks mr-2"></i> <span class="hidden sm:inline">Atendimento</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-rastreabilidade" class="nav-link text-white py-3 px-4 md:px-6 block font-medium text-sm md:text-base">
                                <i class="fas fa-search mr-2"></i> <span class="hidden sm:inline">Rastreabilidade</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Conteúdo Principal -->
        <main class="container mx-auto px-4 py-6 md:py-8">
            <!-- Tela de Requisição -->
            <div id="requisicao-screen" class="fade-in">
                <div class="bg-white rounded-xl card-shadow p-4 md:p-6 mb-6 md:mb-8">
                    <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4 md:mb-6">Nova Requisição de Material</h2>
                    
                    <form id="requisicao-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <div>
                                <label for="requisitante" class="block text-gray-700 text-sm font-medium mb-2">Requisitante</label>
                                <input type="text" id="requisitante" class="w-full px-3 md:px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-sm md:text-base" readonly>
                            </div>
                            
                            <div>
                                <label for="setor" class="block text-gray-700 text-sm font-medium mb-2">Setor</label>
                                <select id="setor" class="w-full px-3 md:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" required>
                                    <option value="" disabled selected>Selecione o setor</option>
                                    <option value="Administração">Administração</option>
                                    <option value="Acabamento">Acabamento</option>
                                    <option value="Qualidade">Qualidade</option>
                                    <option value="PDI">PDI</option>
                                    <option value="Usinagem">Usinagem</option>
                                    <option value="Area limpa">Área limpa</option>
                                    <option value="Quarentena">Quarentena</option>
                                    <option value="Expedição">Expedição</option>
                                    <option value="Manutenção">Manutenção</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="material" class="block text-gray-700 text-sm font-medium mb-2">Material</label>
                                <input type="text" id="material" class="w-full px-3 md:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" placeholder="Descrição do material" required>
                            </div>
                            
                            <div>
                                <label for="quantidade" class="block text-gray-700 text-sm font-medium mb-2">Quantidade</label>
                                <input type="number" id="quantidade" class="w-full px-3 md:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" min="1" value="1" required>
                            </div>
                        </div>
                        
                        <div class="mt-4 md:mt-6">
                            <label for="observacoes" class="block text-gray-700 text-sm font-medium mb-2">Observações</label>
                            <textarea id="observacoes" class="w-full px-3 md:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" rows="3" placeholder="Informações adicionais (opcional)"></textarea>
                        </div>
                        
                        <div class="mt-6 md:mt-8 flex justify-end">
                            <button type="submit" class="bg-primary text-white py-2 px-4 md:px-6 rounded-lg hover:bg-secondary transition duration-200 font-medium text-sm md:text-base">
                                <i class="fas fa-paper-plane mr-2"></i> Enviar Requisição
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Histórico de Requisições do Usuário -->
                <div class="bg-white rounded-xl card-shadow p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4 md:mb-6">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Minhas Requisições</h2>
                        <button id="refresh-user-requests" class="bg-primary text-white py-1 px-3 rounded-lg hover:bg-secondary transition duration-200 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Atualizar
                        </button>
                    </div>
                    <div id="user-requests" class="space-y-3 md:space-y-4">
                        <!-- As requisições do usuário serão carregadas aqui -->
                    </div>
                </div>
            </div>

            <!-- Tela de Atendimento (apenas para admin) -->
            <div id="atendimento-screen" class="hidden fade-in">
                <div class="bg-white rounded-xl card-shadow p-4 md:p-6">
                    <div class="flex justify-between items-center mb-4 md:mb-6">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Atendimento de Requisições</h2>
                        <button id="refresh-admin-requests" class="bg-primary text-white py-1 px-3 rounded-lg hover:bg-secondary transition duration-200 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Atualizar
                        </button>
                    </div>
                    
                    <div class="mb-4 md:mb-6 flex flex-wrap gap-2">
                        <button class="filter-btn active bg-primary text-white py-1 px-2 md:px-3 rounded-lg text-xs md:text-sm" data-status="todos">Todos</button>
                        <button class="filter-btn bg-gray-200 text-gray-700 py-1 px-2 md:px-3 rounded-lg text-xs md:text-sm" data-status="pendente">Pendentes</button>
                        <button class="filter-btn bg-info text-white py-1 px-2 md:px-3 rounded-lg text-xs md:text-sm" data-status="espera">Em Espera</button>
                        <button class="filter-btn bg-warning text-white py-1 px-2 md:px-3 rounded-lg text-xs md:text-sm" data-status="aprovado">Aprovados</button>
                        <button class="filter-btn bg-success text-white py-1 px-2 md:px-3 rounded-lg text-xs md:text-sm" data-status="entregue">Entregues</button>
                        <button class="filter-btn bg-danger text-white py-1 px-2 md:px-3 rounded-lg text-xs md:text-sm" data-status="negado">Negados</button>
                    </div>
                    
                    <div id="requests-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <!-- Os cards de requisição serão carregados aqui -->
                    </div>
                </div>
            </div>

            <!-- Tela de Rastreabilidade -->
            <div id="rastreabilidade-screen" class="hidden fade-in">
                <div class="bg-white rounded-xl card-shadow p-4 md:p-6 mb-6">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 md:mb-6 gap-4">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Rastreabilidade de Requisições</h2>
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="export-pdf-btn" class="bg-danger text-white py-2 px-3 md:px-4 rounded-lg hover:bg-red-700 transition duration-200 font-medium text-sm md:text-base order-2 sm:order-1">
                                <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
                            </button>
                            <button id="refresh-data-btn" class="bg-primary text-white py-2 px-3 md:px-4 rounded-lg hover:bg-secondary transition duration-200 font-medium text-sm md:text-base order-1 sm:order-2">
                                <i class="fas fa-sync-alt mr-2"></i> Atualizar
                            </button>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Data Início</label>
                            <input type="date" id="filter-data-inicio" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Data Fim</label>
                            <input type="date" id="filter-data-fim" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Status</label>
                            <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="todos">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="espera">Em Espera</option>
                                <option value="aprovado">Aprovado</option>
                                <option value="entregue">Entregue</option>
                                <option value="negado">Negado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-2">Setor</label>
                            <select id="filter-setor" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="todos">Todos</option>
                                <option value="Administração">Administração</option>
                                <option value="Acabamento">Acabamento</option>
                                <option value="Qualidade">Qualidade</option>
                                <option value="PDI">PDI</option>
                                <option value="Usinagem">Usinagem</option>
                                <option value="Area limpa">Área limpa</option>
                                <option value="Quarentena">Quarentena</option>
                                <option value="Expedição">Expedição</option>
                            </select>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-4 mb-4 md:mb-6">
                        <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center">
                            <div class="text-xl md:text-2xl font-bold text-primary" id="total-requisicoes">0</div>
                            <div class="text-xs md:text-sm text-gray-600">Total</div>
                        </div>
                        <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center">
                            <div class="text-xl md:text-2xl font-bold text-warning" id="requisicoes-pendentes">0</div>
                            <div class="text-xs md:text-sm text-gray-600">Pendentes</div>
                        </div>
                        <div class="bg-purple-50 p-3 md:p-4 rounded-lg text-center">
                            <div class="text-xl md:text-2xl font-bold text-info" id="requisicoes-espera">0</div>
                            <div class="text-xs md:text-sm text-gray-600">Em Espera</div>
                        </div>
                        <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center">
                            <div class="text-xl md:text-2xl font-bold text-success" id="requisicoes-entregues">0</div>
                            <div class="text-xs md:text-sm text-gray-600">Entregues</div>
                        </div>
                        <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center">
                            <div class="text-xl md:text-2xl font-bold text-danger" id="requisicoes-negadas">0</div>
                            <div class="text-xs md:text-sm text-gray-600">Negadas</div>
                        </div>
                        <div class="bg-gray-50 p-3 md:p-4 rounded-lg text-center">
                            <div class="text-xl md:text-2xl font-bold text-gray-600" id="requisicoes-aprovadas">0</div>
                            <div class="text-xs md:text-sm text-gray-600">Aprovadas</div>
                        </div>
                    </div>

                    <!-- Indicador de Carregamento -->
                    <div id="loading-indicator" class="hidden mb-4">
                        <div class="flex items-center justify-center p-4">
                            <div class="loading-spinner"></div>
                            <span class="ml-3 text-gray-600">Carregando dados...</span>
                        </div>
                    </div>

                    <!-- Tabela de Rastreabilidade - Versão Desktop -->
                    <div class="hidden md:block overflow-x-auto mobile-scroll">
                        <table class="w-full table-auto responsive-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requisitante</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center">Qtd</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Histórico</th>
                                </tr>
                            </thead>
                            <tbody id="rastreabilidade-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Dados serão preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Versão Mobile Cards -->
                    <div id="rastreabilidade-mobile-cards" class="md:hidden space-y-3">
                        <!-- Cards serão gerados via JavaScript para mobile -->
                    </div>

                    <!-- Mensagem quando não há dados -->
                    <div id="no-data-message" class="hidden text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Nenhuma requisição encontrada</p>
                    </div>

                    <!-- Paginação -->
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4 md:mt-6 gap-3">
                        <div class="text-xs md:text-sm text-gray-600">
                            Mostrando <span id="current-count">0</span> de <span id="total-count">0</span> registros
                        </div>
                        <div class="flex space-x-2">
                            <button id="prev-page" class="px-3 py-1 border border-gray-300 rounded disabled:opacity-50 text-sm">Anterior</button>
                            <span id="page-info" class="px-3 py-1 text-sm">Página 1</span>
                            <button id="next-page" class="px-3 py-1 border border-gray-300 rounded disabled:opacity-50 text-sm">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-4 md:p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Confirmar Ação</h3>
            <p id="confirmation-message" class="text-gray-600 mb-6">Tem certeza que deseja prosseguir?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-action" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 text-sm md:text-base">Cancelar</button>
                <button id="confirm-action" class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-secondary transition duration-200 text-sm md:text-base">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para motivo da negação -->
    <div id="deny-reason-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-4 md:p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Motivo da Negação</h3>
            <p class="text-gray-600 mb-4">Por favor, informe o motivo para negar esta requisição:</p>
            <textarea id="deny-reason-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" rows="4" placeholder="Digite o motivo da negação..." required></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-deny" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 text-sm md:text-base">Cancelar</button>
                <button id="confirm-deny" class="bg-danger text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 text-sm md:text-base">Confirmar Negação</button>
            </div>
        </div>
    </div>

    <!-- Modal para colocar em espera -->
    <div id="wait-reason-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-4 md:p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Colocar Requisição em Espera</h3>
            <p class="text-gray-600 mb-4">Por favor, informe o motivo para colocar esta requisição em espera:</p>
            <textarea id="wait-reason-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm md:text-base" rows="4" placeholder="Digite o motivo para colocar em espera..." required></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancel-wait" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200 text-sm md:text-base">Cancelar</button>
                <button id="confirm-wait" class="bg-info text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 text-sm md:text-base">Colocar em Espera</button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar histórico -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-4 md:p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Histórico Completo da Requisição</h3>
                <button id="close-history" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="history-content" class="space-y-4">
                <!-- Conteúdo do histórico será preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Estado da aplicação
        const state = {
            currentUser: null,
            isAdmin: false,
            requests: [],
            currentFilter: 'todos',
            unsubscribeRequests: null,
            // Novos estados para rastreabilidade
            currentPage: 1,
            itemsPerPage: 10,
            filteredRequests: [],
            currentDenyRequestId: null,
            currentWaitRequestId: null,
            lastRefresh: null,
            isLoading: false
        };

        // Elementos da DOM
        const elements = {
            loginScreen: document.getElementById('login-screen'),
            mainScreen: document.getElementById('main-screen'),
            loginForm: document.getElementById('login-form'),
            emailInput: document.getElementById('email'),
            passwordInput: document.getElementById('password'),
            userInfo: document.getElementById('user-info'),
            logoutBtn: document.getElementById('logout-btn'),
            navRequisicao: document.getElementById('nav-requisicao'),
            navAtendimento: document.getElementById('nav-atendimento'),
            navRastreabilidade: document.getElementById('nav-rastreabilidade'),
            requisicaoScreen: document.getElementById('requisicao-screen'),
            atendimentoScreen: document.getElementById('atendimento-screen'),
            rastreabilidadeScreen: document.getElementById('rastreabilidade-screen'),
            requisicaoForm: document.getElementById('requisicao-form'),
            requisitanteInput: document.getElementById('requisitante'),
            setorSelect: document.getElementById('setor'),
            materialInput: document.getElementById('material'),
            quantidadeInput: document.getElementById('quantidade'),
            observacoesTextarea: document.getElementById('observacoes'),
            userRequests: document.getElementById('user-requests'),
            requestsContainer: document.getElementById('requests-container'),
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmationMessage: document.getElementById('confirmation-message'),
            cancelAction: document.getElementById('cancel-action'),
            confirmAction: document.getElementById('confirm-action'),
            // Novos elementos para rastreabilidade
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            refreshDataBtn: document.getElementById('refresh-data-btn'),
            refreshUserRequests: document.getElementById('refresh-user-requests'),
            refreshAdminRequests: document.getElementById('refresh-admin-requests'),
            filterDataInicio: document.getElementById('filter-data-inicio'),
            filterDataFim: document.getElementById('filter-data-fim'),
            filterStatus: document.getElementById('filter-status'),
            filterSetor: document.getElementById('filter-setor'),
            rastreabilidadeTableBody: document.getElementById('rastreabilidade-table-body'),
            totalRequisicoes: document.getElementById('total-requisicoes'),
            requisicoesPendentes: document.getElementById('requisicoes-pendentes'),
            requisicoesEspera: document.getElementById('requisicoes-espera'),
            requisicoesEntregues: document.getElementById('requisicoes-entregues'),
            requisicoesNegadas: document.getElementById('requisicoes-negadas'),
            requisicoesAprovadas: document.getElementById('requisicoes-aprovadas'),
            currentCount: document.getElementById('current-count'),
            totalCount: document.getElementById('total-count'),
            pageInfo: document.getElementById('page-info'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            // Novos modais
            denyReasonModal: document.getElementById('deny-reason-modal'),
            denyReasonInput: document.getElementById('deny-reason-input'),
            cancelDeny: document.getElementById('cancel-deny'),
            confirmDeny: document.getElementById('confirm-deny'),
            waitReasonModal: document.getElementById('wait-reason-modal'),
            waitReasonInput: document.getElementById('wait-reason-input'),
            cancelWait: document.getElementById('cancel-wait'),
            confirmWait: document.getElementById('confirm-wait'),
            historyModal: document.getElementById('history-modal'),
            historyContent: document.getElementById('history-content'),
            closeHistory: document.getElementById('close-history'),
            // Elementos de loading - CORRIGIDOS
            loadingIndicator: document.getElementById('loading-indicator'),
            noDataMessage: document.getElementById('no-data-message'),
            rastreabilidadeMobileCards: document.getElementById('rastreabilidade-mobile-cards')
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar estado de autenticação
            window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                console.log('onAuthStateChanged chamado, usuário:', user);
                
                if (user) {
                    console.log('Usuário autenticado:', user.email);
                    state.currentUser = user;
                    
                    try {
                        // Verificar se é admin
                        state.isAdmin = await checkIfUserIsAdmin(user);
                        console.log('É admin?', state.isAdmin);
                        
                        showMainScreen();
                        setupRealtimeListener();
                    } catch (error) {
                        console.error('Erro ao verificar admin:', error);
                        // Mesmo com erro, permite login como usuário normal
                        state.isAdmin = false;
                        showMainScreen();
                        setupRealtimeListener();
                    }
                } else {
                    console.log('Nenhum usuário autenticado');
                    showLoginScreen();
                }
            });

            // Event Listeners
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.logoutBtn.addEventListener('click', handleLogout);
            elements.navRequisicao.addEventListener('click', () => showScreen('requisicao'));
            elements.navAtendimento.addEventListener('click', () => showScreen('atendimento'));
            elements.navRastreabilidade.addEventListener('click', () => showScreen('rastreabilidade'));
            elements.requisicaoForm.addEventListener('submit', handleNewRequest);
            elements.cancelAction.addEventListener('click', hideConfirmationModal);
            
            // Botões de atualização
            elements.refreshUserRequests.addEventListener('click', forceRefreshData);
            elements.refreshAdminRequests.addEventListener('click', forceRefreshData);
            elements.refreshDataBtn.addEventListener('click', forceRefreshData);
            
            // Adicionar event listeners para os botões de filtro
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'bg-primary', 'bg-info'));
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        if (b.dataset.status !== 'todos' && b.dataset.status !== 'pendente' && b.dataset.status !== 'espera') {
                            b.classList.remove('text-white');
                        }
                    });
                    
                    this.classList.add('active');
                    if (this.dataset.status === 'espera') {
                        this.classList.add('bg-info', 'text-white');
                    } else if (this.dataset.status !== 'pendente') {
                        this.classList.add('bg-primary', 'text-white');
                    } else {
                        this.classList.add('bg-primary');
                    }
                    
                    state.currentFilter = this.dataset.status;
                    renderRequests();
                });
            });

            // Novos event listeners para rastreabilidade
            elements.exportPdfBtn.addEventListener('click', exportToPDF);
            elements.filterDataInicio.addEventListener('change', applyFilters);
            elements.filterDataFim.addEventListener('change', applyFilters);
            elements.filterStatus.addEventListener('change', applyFilters);
            elements.filterSetor.addEventListener('change', applyFilters);
            elements.prevPage.addEventListener('click', previousPage);
            elements.nextPage.addEventListener('click', nextPage);

            // Event listeners para os novos modais
            elements.cancelDeny.addEventListener('click', hideDenyReasonModal);
            elements.confirmDeny.addEventListener('click', handleConfirmDeny);
            elements.cancelWait.addEventListener('click', hideWaitReasonModal);
            elements.confirmWait.addEventListener('click', handleConfirmWait);
            elements.closeHistory.addEventListener('click', hideHistoryModal);

            // Configurar datas padrão (últimos 30 dias)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            elements.filterDataInicio.value = startDate.toISOString().split('T')[0];
            elements.filterDataFim.value = endDate.toISOString().split('T')[0];
        });

        // Função para forçar atualização dos dados - CORRIGIDA
        function forceRefreshData() {
            console.log('Forçando atualização dos dados...');
            state.isLoading = true;
            state.lastRefresh = new Date();
            
            // Mostrar indicador de carregamento apenas se estiver na tela de rastreabilidade
            if (!elements.rastreabilidadeScreen.classList.contains('hidden')) {
                elements.loadingIndicator.classList.remove('hidden');
                if (elements.rastreabilidadeTableBody) {
                    elements.rastreabilidadeTableBody.innerHTML = '';
                }
                if (elements.rastreabilidadeMobileCards) {
                    elements.rastreabilidadeMobileCards.innerHTML = '';
                }
            }
            
            // Recarregar dados manualmente
            loadDataManually().then(() => {
                state.isLoading = false;
                if (elements.loadingIndicator) {
                    elements.loadingIndicator.classList.add('hidden');
                }
                
                // Atualizar todas as interfaces
                renderUserRequests();
                if (state.isAdmin) {
                    renderRequests();
                    if (!elements.rastreabilidadeScreen.classList.contains('hidden')) {
                        applyFilters();
                    }
                }
                
                // Mostrar mensagem de sucesso
                showToast('Dados atualizados com sucesso!', 'success');
            }).catch(error => {
                state.isLoading = false;
                if (elements.loadingIndicator) {
                    elements.loadingIndicator.classList.add('hidden');
                }
                console.error('Erro ao atualizar dados:', error);
                showToast('Erro ao atualizar dados', 'error');
            });
        }

        // Função para carregar dados manualmente (sem cache) - CORRIGIDA
        async function loadDataManually() {
            return new Promise(async (resolve, reject) => {
                try {
                    console.log('Carregando dados manualmente...');
                    
                    const q = window.firebase.query(
                        window.firebase.collection(window.firebase.db, "requisicoes"),
                        window.firebase.orderBy("timestamp", "desc")
                    );

                    const querySnapshot = await window.firebase.getDocs(q);
                    const newRequests = [];
                    
                    querySnapshot.forEach((doc) => {
                        const request = doc.data();
                        request.id = doc.id;
                        
                        // Garantir que a data está formatada
                        if (!request.data && request.timestamp) {
                            const timestamp = request.timestamp.toDate ? request.timestamp.toDate() : new Date(request.timestamp);
                            request.data = timestamp.toLocaleString('pt-BR');
                        } else if (!request.data) {
                            request.data = new Date().toLocaleString('pt-BR');
                        }
                        
                        // Garantir que o histórico existe
                        if (!request.historico) {
                            request.historico = [{
                                acao: 'requisicao_aberta',
                                usuario: request.email,
                                nomeUsuario: request.requisitante,
                                data: request.data,
                                timestamp: request.timestamp || new Date(),
                                detalhes: 'Requisição criada'
                            }];
                        }
                        
                        newRequests.push(request);
                    });
                    
                    state.requests = newRequests;
                    console.log('Dados carregados manualmente:', state.requests.length, 'requisições');
                    resolve();
                } catch (error) {
                    console.error('Erro ao carregar dados manualmente:', error);
                    reject(error);
                }
            });
        }

        // Configurar listener em tempo real para as requisições - CORRIGIDA
        function setupRealtimeListener() {
            if (state.unsubscribeRequests) {
                state.unsubscribeRequests();
            }

            console.log('Configurando listener em tempo real...');
            
            try {
                const q = window.firebase.query(
                    window.firebase.collection(window.firebase.db, "requisicoes"),
                    window.firebase.orderBy("timestamp", "desc")
                );

                state.unsubscribeRequests = window.firebase.onSnapshot(q, 
                    // onNext
                    (querySnapshot) => {
                        console.log('Listener: dados recebidos', querySnapshot.size, 'documentos');
                        handleSnapshotUpdate(querySnapshot);
                    },
                    // onError
                    (error) => {
                        console.error('Erro no listener em tempo real:', error);
                        showToast('Erro na conexão em tempo real', 'error');
                        
                        // Tentar reconectar após 5 segundos
                        setTimeout(() => {
                            console.log('Tentando reconectar listener...');
                            setupRealtimeListener();
                        }, 5000);
                    }
                );
            } catch (error) {
                console.error('Erro ao configurar listener:', error);
                // Tentar novamente depois de um tempo
                setTimeout(() => setupRealtimeListener(), 3000);
            }
        }

        // Função para processar atualizações do snapshot - CORRIGIDA
        function handleSnapshotUpdate(querySnapshot) {
            const newRequests = [];
            let hasChanges = false;

            querySnapshot.forEach((doc) => {
                const request = doc.data();
                request.id = doc.id;
                
                // Garantir que a data está formatada
                if (!request.data && request.timestamp) {
                    const timestamp = request.timestamp.toDate ? request.timestamp.toDate() : new Date(request.timestamp);
                    request.data = timestamp.toLocaleString('pt-BR');
                } else if (!request.data) {
                    request.data = new Date().toLocaleString('pt-BR');
                }
                
                // Garantir que o histórico existe
                if (!request.historico) {
                    request.historico = [{
                        acao: 'requisicao_aberta',
                        usuario: request.email,
                        nomeUsuario: request.requisitante,
                        data: request.data,
                        timestamp: request.timestamp || new Date(),
                        detalhes: 'Requisição criada'
                    }];
                }
                
                newRequests.push(request);
            });

            // Verificar se houve mudanças
            if (state.requests.length !== newRequests.length) {
                hasChanges = true;
            } else {
                // Verificar se o conteúdo mudou
                for (let i = 0; i < newRequests.length; i++) {
                    const newReq = newRequests[i];
                    const oldReq = state.requests.find(r => r.id === newReq.id);
                    
                    if (!oldReq || JSON.stringify(oldReq) !== JSON.stringify(newReq)) {
                        hasChanges = true;
                        break;
                    }
                }
            }

            if (hasChanges || state.requests.length === 0) {
                console.log('Mudanças detectadas, atualizando interface...');
                state.requests = newRequests;
                
                // Atualizar todas as interfaces
                renderUserRequests();
                if (state.isAdmin) {
                    renderRequests();
                    if (!elements.rastreabilidadeScreen.classList.contains('hidden')) {
                        applyFilters();
                    }
                }
                
                // Mostrar notificação de atualização se não foi uma ação do usuário
                if (!state.isLoading) {
                    showToast('Dados atualizados', 'info');
                }
            }
        }

        // Funções de manipulação de eventos
        async function handleLogin(e) {
            e.preventDefault();
            const email = elements.emailInput.value.trim();
            const password = elements.passwordInput.value.trim();
            
            if (email && password) {
                try {
                    console.log('Tentando login com:', email);
                    
                    // Desabilitar o botão de login para evitar múltiplos cliques
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Entrando...';
                    
                    // Fazer login
                    const userCredential = await window.firebase.signInWithEmailAndPassword(
                        window.firebase.auth, 
                        email, 
                        password
                    );
                    
                    console.log('Login bem-sucedido:', userCredential.user.email);
                    
                } catch (error) {
                    console.error('Erro no login:', error);
                    
                    // Reativar o botão
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Entrar';
                    
                    let errorMessage = 'Erro no login. ';
                    
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage += 'Email inválido.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage += 'Usuário desativado.';
                            break;
                        case 'auth/user-not-found':
                            errorMessage += 'Usuário não encontrado.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage += 'Senha incorreta.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage += 'Muitas tentativas. Tente novamente mais tarde.';
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                }
            } else {
                alert('Por favor, preencha todos os campos.');
            }
        }

        async function handleLogout() {
            try {
                if (state.unsubscribeRequests) {
                    state.unsubscribeRequests();
                }
                await window.firebase.signOut(window.firebase.auth);
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }

        async function handleNewRequest(e) {
            e.preventDefault();
            
            const newRequest = {
                requisitante: state.currentUser.displayName || state.currentUser.email.split('@')[0],
                email: state.currentUser.email,
                setor: elements.setorSelect.value,
                material: elements.materialInput.value,
                quantidade: parseInt(elements.quantidadeInput.value),
                observacoes: elements.observacoesTextarea.value,
                data: new Date().toLocaleString('pt-BR'),
                timestamp: new Date(),
                status: 'pendente',
                historico: [{
                    acao: 'requisicao_aberta',
                    usuario: state.currentUser.email,
                    nomeUsuario: state.currentUser.displayName || state.currentUser.email.split('@')[0],
                    data: new Date().toLocaleString('pt-BR'),
                    timestamp: new Date(),
                    detalhes: 'Requisição criada'
                }]
            };
            
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.firebase.db, "requisicoes"), 
                    newRequest
                );
                
                // Limpar o formulário
                elements.requisicaoForm.reset();
                elements.quantidadeInput.value = 1;
                
                // Mostrar mensagem de sucesso
                alert('Requisição enviada com sucesso!');
                
                // Forçar atualização imediata
                setTimeout(() => {
                    forceRefreshData();
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao enviar requisição:', error);
                alert('Erro ao enviar requisição. Tente novamente.');
            }
        }

        async function checkIfUserIsAdmin(user) {
            try {
                console.log('Verificando se usuário é admin:', user.email);
                
                // Lista de administradores - ADICIONE SEUS EMAILS AQUI
                const adminEmails = [
                    'erick@ibeg.com',
                    'guilherme@ibeg.com',
                    'admin@empresa.com'
                ];
                
                const isAdmin = adminEmails.includes(user.email.toLowerCase());
                console.log('Usuário é admin?', isAdmin);
                return isAdmin;
                
            } catch (error) {
                console.error('Erro ao verificar admin:', error);
                return false;
            }
        }

        // Funções de renderização
        function showLoginScreen() {
            elements.loginScreen.classList.remove('hidden');
            elements.mainScreen.classList.add('hidden');
            elements.emailInput.value = '';
            elements.passwordInput.value = '';
        }

        function showMainScreen() {
            console.log('Mostrando tela principal para:', state.currentUser.email);
            
            elements.loginScreen.classList.add('hidden');
            elements.mainScreen.classList.remove('hidden');
            
            // Atualizar informações do usuário
            const displayName = state.currentUser.displayName || state.currentUser.email.split('@')[0];
            elements.userInfo.textContent = `Olá, ${displayName}`;
            elements.requisitanteInput.value = displayName;
            
            // Mostrar a tela apropriada
            if (state.isAdmin) {
                console.log('Usuário é admin, mostrando todas as abas');
                elements.navAtendimento.classList.remove('hidden');
                elements.navRastreabilidade.classList.remove('hidden');
                showScreen('atendimento');
            } else {
                console.log('Usuário não é admin, mostrando apenas requisição');
                elements.navAtendimento.classList.add('hidden');
                elements.navRastreabilidade.classList.add('hidden');
                showScreen('requisicao');
            }
        }

        function showScreen(screen) {
            // Atualizar navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active', 'bg-primary', 'bg-opacity-20');
            });
            
            if (screen === 'requisicao') {
                elements.requisicaoScreen.classList.remove('hidden');
                elements.atendimentoScreen.classList.add('hidden');
                elements.rastreabilidadeScreen.classList.add('hidden');
                elements.navRequisicao.classList.add('active', 'bg-primary', 'bg-opacity-20');
            } else if (screen === 'atendimento') {
                elements.requisicaoScreen.classList.add('hidden');
                elements.atendimentoScreen.classList.remove('hidden');
                elements.rastreabilidadeScreen.classList.add('hidden');
                elements.navAtendimento.classList.add('active', 'bg-primary', 'bg-opacity-20');
                renderRequests();
            } else if (screen === 'rastreabilidade') {
                elements.requisicaoScreen.classList.add('hidden');
                elements.atendimentoScreen.classList.add('hidden');
                elements.rastreabilidadeScreen.classList.remove('hidden');
                elements.navRastreabilidade.classList.add('active', 'bg-primary', 'bg-opacity-20');
                applyFilters();
            }
        }

        function renderUserRequests() {
            const userRequests = state.requests.filter(req => req.email === state.currentUser.email);
            
            if (userRequests.length === 0) {
                elements.userRequests.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>Nenhuma requisição encontrada</p>
                    </div>
                `;
                return;
            }
            
            elements.userRequests.innerHTML = userRequests.map(request => {
                // Verificar se há notificações (motivo de negação ou espera) - CORRIGIDO
                // A mensagem só aparece se a requisição NÃO estiver aprovada/entregue e a notificação não foi vista
                const negacao = request.historico?.find(h => h.acao === 'requisicao_negada');
                const espera = request.historico?.find(h => h.acao === 'requisicao_em_espera');
                
                // Mensagem só aparece se:
                // 1. A requisição NÃO está aprovada ou entregue
                // 2. E existe uma notificação (negação ou espera)
                // 3. E a notificação não foi marcada como vista
                const mostrarNegacao = negacao && !negacao.vista && request.status !== 'aprovado' && request.status !== 'entregue';
                const mostrarEspera = espera && !espera.vista && request.status !== 'aprovado' && request.status !== 'entregue';
                const temNotificacao = mostrarNegacao || mostrarEspera;
                
                return `
                <div class="border border-gray-200 rounded-lg p-3 md:p-4 ${temNotificacao ? 'bg-yellow-50 border-yellow-200' : ''}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-gray-800 text-sm md:text-base">${request.material}</h3>
                        <div class="flex items-center">
                            ${temNotificacao ? `
                            <span class="bg-yellow-500 text-white text-xs py-1 px-2 rounded-full mr-2 animate-pulse">
                                <i class="fas fa-exclamation-circle mr-1"></i> Nova
                            </span>
                            ` : ''}
                            <span class="status-badge ${getStatusClass(request.status)} text-xs py-1 px-2 rounded-full">${getStatusText(request.status)}</span>
                        </div>
                    </div>
                    <div class="text-xs md:text-sm text-gray-600 mb-1">
                        <span class="font-medium">Setor:</span> ${request.setor}
                    </div>
                    <div class="text-xs md:text-sm text-gray-600 mb-1">
                        <span class="font-medium">Quantidade:</span> ${request.quantidade}
                    </div>
                    <div class="text-xs md:text-sm text-gray-600 mb-1">
                        <span class="font-medium">Data:</span> ${request.data}
                    </div>
                    ${mostrarNegacao ? `
                    <div class="mt-2 p-2 bg-red-100 border border-red-200 rounded text-xs text-red-700">
                        <div class="font-medium mb-1">Motivo da negação:</div>
                        <div>${negacao.motivo || negacao.detalhes}</div>
                        <div class="text-xs mt-1 text-red-600">Por: ${negacao.nomeUsuario || negacao.usuario} em ${negacao.data}</div>
                    </div>
                    ` : ''}
                    ${mostrarEspera ? `
                    <div class="mt-2 p-2 bg-purple-100 border border-purple-200 rounded text-xs text-purple-700">
                        <div class="font-medium mb-1">Motivo da espera:</div>
                        <div>${espera.motivo || espera.detalhes}</div>
                        <div class="text-xs mt-1 text-purple-600">Por: ${espera.nomeUsuario || espera.usuario} em ${espera.data}</div>
                    </div>
                    ` : ''}
                    ${request.observacoes ? `<div class="text-xs md:text-sm text-gray-600 mt-2">
                        <span class="font-medium">Observações:</span> ${request.observacoes}
                    </div>` : ''}
                    ${temNotificacao ? `
                    <div class="mt-2 text-right">
                        <button class="text-xs text-primary hover:underline marcar-vista-btn" data-id="${request.id}">
                            Marcar como lida
                        </button>
                    </div>
                    ` : ''}
                </div>
            `}).join('');
            
            // Adicionar event listeners para marcar como lida
            document.querySelectorAll('.marcar-vista-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    marcarNotificacaoComoVista(this.dataset.id);
                });
            });
        }

        async function marcarNotificacaoComoVista(requestId) {
            try {
                const request = state.requests.find(req => req.id === requestId);
                if (!request) return;
                
                const historicoAtualizado = request.historico.map(item => {
                    if (item.acao === 'requisicao_negada' || item.acao === 'requisicao_em_espera') {
                        return { ...item, vista: true };
                    }
                    return item;
                });
                
                const requestRef = window.firebase.doc(window.firebase.db, "requisicoes", requestId);
                await window.firebase.updateDoc(requestRef, {
                    historico: historicoAtualizado
                });
                
                // Forçar atualização imediata
                setTimeout(() => {
                    forceRefreshData();
                }, 500);
                
            } catch (error) {
                console.error('Erro ao marcar notificação como vista:', error);
            }
        }

        function renderRequests() {
            let filteredRequests = state.requests;
            
            // Aplicar filtro
            if (state.currentFilter !== 'todos') {
                filteredRequests = state.requests.filter(req => req.status === state.currentFilter);
            }
            
            if (filteredRequests.length === 0) {
                elements.requestsContainer.innerHTML = `
                    <div class="col-span-full text-center py-8 md:py-12 text-gray-500">
                        <i class="fas fa-inbox text-4xl md:text-5xl mb-3 md:mb-4"></i>
                        <p class="text-base md:text-lg">Nenhuma requisição encontrada</p>
                    </div>
                `;
                return;
            }
            
            elements.requestsContainer.innerHTML = filteredRequests.map(request => {
                const negacao = request.historico?.find(h => h.acao === 'requisicao_negada');
                const espera = request.historico?.find(h => h.acao === 'requisicao_em_espera');
                
                return `
                <div class="bg-white border border-gray-200 rounded-xl card-shadow overflow-hidden">
                    <div class="p-3 md:p-4 border-b border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800 text-base md:text-lg">${request.material}</h3>
                            <span class="status-badge ${getStatusClass(request.status)} text-xs py-1 px-2 rounded-full">${getStatusText(request.status)}</span>
                        </div>
                        <div class="text-xs md:text-sm text-gray-600 mb-1">
                            <i class="fas fa-user mr-1"></i> ${request.requisitante}
                        </div>
                        <div class="text-xs md:text-sm text-gray-600 mb-1">
                            <i class="fas fa-building mr-1"></i> ${request.setor}
                        </div>
                        <div class="text-xs md:text-sm text-gray-600">
                            <i class="fas fa-calendar mr-1"></i> ${request.data}
                        </div>
                    </div>
                    
                    <div class="p-3 md:p-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-xs md:text-sm text-gray-600">Quantidade:</span>
                            <span class="font-medium text-sm md:text-base">${request.quantidade}</span>
                        </div>
                        
                        ${negacao ? `
                        <div class="mb-3 md:mb-4 p-2 bg-red-50 border border-red-200 rounded">
                            <div class="text-xs text-red-700 font-medium mb-1">Motivo da negação:</div>
                            <div class="text-xs text-red-600">${negacao.motivo || negacao.detalhes}</div>
                        </div>
                        ` : ''}
                        
                        ${espera ? `
                        <div class="mb-3 md:mb-4 p-2 bg-purple-50 border border-purple-200 rounded">
                            <div class="text-xs text-purple-700 font-medium mb-1">Motivo da espera:</div>
                            <div class="text-xs text-purple-600">${espera.motivo || espera.detalhes}</div>
                        </div>
                        ` : ''}
                        
                        ${request.observacoes ? `
                        <div class="mb-3 md:mb-4">
                            <span class="text-xs md:text-sm text-gray-600 block mb-1">Observações:</span>
                            <p class="text-xs md:text-sm bg-gray-50 p-2 rounded">${request.observacoes}</p>
                        </div>
                        ` : ''}
                        
                        <div class="flex flex-col sm:flex-row sm:space-x-2 space-y-2 sm:space-y-0 mt-3 md:mt-4">
                            ${request.status === 'pendente' || request.status === 'espera' ? `
                            <button class="flex-1 bg-success text-white py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-green-700 transition duration-200 approve-btn" data-id="${request.id}">
                                <i class="fas fa-check mr-1"></i> Aprovar
                            </button>
                            <button class="flex-1 bg-info text-white py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-purple-700 transition duration-200 wait-btn" data-id="${request.id}">
                                <i class="fas fa-pause mr-1"></i> Espera
                            </button>
                            <button class="flex-1 bg-danger text-white py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-red-700 transition duration-200 deny-btn" data-id="${request.id}">
                                <i class="fas fa-times mr-1"></i> Negar
                            </button>
                            ` : ''}
                            
                            ${request.status === 'aprovado' ? `
                            <button class="flex-1 bg-success text-white py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-green-700 transition duration-200 complete-btn" data-id="${request.id}">
                                <i class="fas fa-check-double mr-1"></i> Entregue
                            </button>
                            <button class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-gray-300 transition duration-200 pendent-btn" data-id="${request.id}">
                                <i class="fas fa-undo mr-1"></i> Reabrir
                            </button>
                            ` : ''}
                            
                            ${request.status === 'entregue' || request.status === 'negado' ? `
                            <button class="flex-1 bg-gray-200 text-gray-700 py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-gray-300 transition duration-200 pendent-btn" data-id="${request.id}">
                                <i class="fas fa-undo mr-1"></i> Reabrir
                            </button>
                            ` : ''}
                            
                            <button class="flex-1 bg-primary text-white py-2 px-3 rounded-lg text-xs md:text-sm hover:bg-secondary transition duration-200 history-btn" data-id="${request.id}">
                                <i class="fas fa-history mr-1"></i> Histórico
                            </button>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            // Adicionar event listeners aos botões
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showConfirmationModal('Deseja aprovar esta requisição?', () => {
                        updateRequestStatus(this.dataset.id, 'aprovado', 'Requisição aprovada');
                    });
                });
            });
            
            document.querySelectorAll('.deny-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showDenyReasonModal(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.wait-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showWaitReasonModal(this.dataset.id);
                });
            });
            
            document.querySelectorAll('.complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showConfirmationModal('Confirmar entrega do material?', () => {
                        updateRequestStatus(this.dataset.id, 'entregue', 'Material entregue');
                    });
                });
            });
            
            document.querySelectorAll('.pendent-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showConfirmationModal('Deseja reabrir esta requisição?', () => {
                        updateRequestStatus(this.dataset.id, 'pendente', 'Requisição reaberta');
                    });
                });
            });
            
            document.querySelectorAll('.history-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showHistoryModal(this.dataset.id);
                });
            });
        }

        // Função updateRequestStatus - CORRIGIDA
        async function updateRequestStatus(id, status, acao) {
            try {
                const request = state.requests.find(req => req.id === id);
                if (!request) return;
                
                // Quando uma requisição é aprovada, marcar automaticamente as notificações como vistas
                let historicoAtualizado = [...request.historico];
                
                if (status === 'aprovado' || status === 'entregue') {
                    historicoAtualizado = historicoAtualizado.map(item => {
                        if (item.acao === 'requisicao_negada' || item.acao === 'requisicao_em_espera') {
                            return { ...item, vista: true };
                        }
                        return item;
                    });
                }
                
                historicoAtualizado.push({
                    acao: `requisicao_${status === 'aprovado' ? 'aprovada' : status === 'negado' ? 'negada' : status === 'entregue' ? 'entregue' : status === 'espera' ? 'em_espera' : 'reaberta'}`,
                    usuario: state.currentUser.email,
                    nomeUsuario: state.currentUser.displayName || state.currentUser.email.split('@')[0],
                    data: new Date().toLocaleString('pt-BR'),
                    timestamp: new Date(),
                    detalhes: acao
                });
                
                const requestRef = window.firebase.doc(window.firebase.db, "requisicoes", id);
                await window.firebase.updateDoc(requestRef, {
                    status: status,
                    historico: historicoAtualizado
                });

                // Forçar atualização imediata dos dados
                setTimeout(() => {
                    forceRefreshData();
                }, 500);
                
            } catch (error) {
                console.error('Erro ao atualizar requisição:', error);
                alert('Erro ao atualizar requisição. Tente novamente.');
            }
        }

        // NOVAS FUNÇÕES PARA ESPERA

        function showWaitReasonModal(requestId) {
            state.currentWaitRequestId = requestId;
            elements.waitReasonInput.value = '';
            elements.waitReasonModal.classList.remove('hidden');
        }

        function hideWaitReasonModal() {
            elements.waitReasonModal.classList.add('hidden');
            state.currentWaitRequestId = null;
        }

        async function handleConfirmWait() {
            const motivo = elements.waitReasonInput.value.trim();
            if (!motivo) {
                alert('Por favor, informe o motivo para colocar em espera.');
                return;
            }

            try {
                const request = state.requests.find(req => req.id === state.currentWaitRequestId);
                if (!request) return;
                
                const novoHistorico = [
                    ...request.historico,
                    {
                        acao: 'requisicao_em_espera',
                        usuario: state.currentUser.email,
                        nomeUsuario: state.currentUser.displayName || state.currentUser.email.split('@')[0],
                        data: new Date().toLocaleString('pt-BR'),
                        timestamp: new Date(),
                        detalhes: 'Requisição colocada em espera',
                        motivo: motivo,
                        vista: false // Para notificação
                    }
                ];
                
                const requestRef = window.firebase.doc(window.firebase.db, "requisicoes", state.currentWaitRequestId);
                await window.firebase.updateDoc(requestRef, {
                    status: 'espera',
                    historico: novoHistorico
                });
                
                hideWaitReasonModal();
                
                // Forçar atualização imediata
                setTimeout(() => {
                    forceRefreshData();
                }, 500);
                
            } catch (error) {
                console.error('Erro ao colocar requisição em espera:', error);
                alert('Erro ao colocar requisição em espera. Tente novamente.');
            }
        }

        // Função applyFilters - CORRIGIDA
        function applyFilters() {
            console.log('Aplicando filtros...', state.requests.length);
            
            let filtered = [...state.requests];

            // Filtro por data
            if (elements.filterDataInicio.value) {
                const startDate = new Date(elements.filterDataInicio.value);
                startDate.setHours(0, 0, 0, 0);
                filtered = filtered.filter(req => {
                    if (!req.timestamp) return false;
                    const reqDate = req.timestamp.toDate ? req.timestamp.toDate() : new Date(req.timestamp);
                    reqDate.setHours(0, 0, 0, 0);
                    return reqDate >= startDate;
                });
            }

            if (elements.filterDataFim.value) {
                const endDate = new Date(elements.filterDataFim.value);
                endDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(req => {
                    if (!req.timestamp) return false;
                    const reqDate = req.timestamp.toDate ? req.timestamp.toDate() : new Date(req.timestamp);
                    return reqDate <= endDate;
                });
            }

            // Filtro por status
            if (elements.filterStatus.value !== 'todos') {
                filtered = filtered.filter(req => req.status === elements.filterStatus.value);
            }

            // Filtro por setor
            if (elements.filterSetor.value !== 'todos') {
                filtered = filtered.filter(req => req.setor === elements.filterSetor.value);
            }

            state.filteredRequests = filtered;
            state.currentPage = 1;
            console.log('Requisições filtradas:', filtered.length);
            updateRastreabilidadeTable();
            updateStatistics();
        }

        function updateRastreabilidadeTable() {
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const paginatedRequests = state.filteredRequests.slice(startIndex, endIndex);

            // Versão Desktop (Tabela)
            elements.rastreabilidadeTableBody.innerHTML = paginatedRequests.map(request => {
                return `
                    <tr class="table-row hover:bg-gray-50">
                        <td class="px-3 py-2 text-sm text-gray-900" title="${request.id}">${request.id.substring(0, 6)}...</td>
                        <td class="px-3 py-2 text-sm text-gray-900">${request.requisitante}</td>
                        <td class="px-3 py-2 text-sm text-gray-900">${request.setor}</td>
                        <td class="px-3 py-2 text-sm text-gray-900" title="${request.material}">${request.material.length > 20 ? request.material.substring(0, 20) + '...' : request.material}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-center">${request.quantidade}</td>
                        <td class="px-3 py-2 text-sm text-gray-900">${request.data}</td>
                        <td class="px-3 py-2 text-sm">
                            <span class="status-badge ${getStatusClass(request.status)} text-xs py-1 px-2 rounded-full">${getStatusText(request.status)}</span>
                        </td>
                        <td class="px-3 py-2 text-sm">
                            <button class="text-primary hover:text-secondary history-btn-table" data-id="${request.id}">
                                <i class="fas fa-history mr-1"></i> Ver Histórico
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Versão Mobile (Cards)
            if (elements.rastreabilidadeMobileCards) {
                elements.rastreabilidadeMobileCards.innerHTML = paginatedRequests.map(request => {
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-3 card-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 text-sm">${request.material}</h3>
                                    <p class="text-xs text-gray-600">${request.requisitante} • ${request.setor}</p>
                                </div>
                                <span class="status-badge ${getStatusClass(request.status)} text-xs py-1 px-2 rounded-full ml-2">${getStatusText(request.status)}</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div>
                                    <span class="text-gray-600">Qtd:</span>
                                    <p class="font-medium">${request.quantidade}</p>
                                </div>
                                <div>
                                    <span class="text-gray-600">Data:</span>
                                    <p class="font-medium">${request.data}</p>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-gray-600">ID:</span>
                                    <p class="font-medium text-xs" title="${request.id}">${request.id.substring(0, 10)}...</p>
                                </div>
                            </div>
                            <div class="mt-2">
                                <button class="w-full text-primary hover:text-secondary text-xs history-btn-table" data-id="${request.id}">
                                    <i class="fas fa-history mr-1"></i> Ver Histórico Completo
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Adicionar event listeners aos botões de histórico na tabela
            document.querySelectorAll('.history-btn-table').forEach(btn => {
                btn.addEventListener('click', function() {
                    showHistoryModal(this.dataset.id);
                });
            });

            // Atualizar informações de paginação
            elements.currentCount.textContent = paginatedRequests.length;
            elements.totalCount.textContent = state.filteredRequests.length;
            elements.pageInfo.textContent = `Página ${state.currentPage}`;
            
            // Atualizar botões de paginação
            elements.prevPage.disabled = state.currentPage === 1;
            elements.nextPage.disabled = endIndex >= state.filteredRequests.length;

            // Mostrar/ocultar mensagem de nenhum dado
            if (elements.noDataMessage) {
                if (state.filteredRequests.length === 0) {
                    elements.noDataMessage.classList.remove('hidden');
                } else {
                    elements.noDataMessage.classList.add('hidden');
                }
            }
        }

        function updateStatistics() {
            const total = state.filteredRequests.length;
            const pendentes = state.filteredRequests.filter(req => req.status === 'pendente').length;
            const espera = state.filteredRequests.filter(req => req.status === 'espera').length;
            const aprovadas = state.filteredRequests.filter(req => req.status === 'aprovado').length;
            const entregues = state.filteredRequests.filter(req => req.status === 'entregue').length;
            const negadas = state.filteredRequests.filter(req => req.status === 'negado').length;

            elements.totalRequisicoes.textContent = total;
            elements.requisicoesPendentes.textContent = pendentes;
            elements.requisicoesEspera.textContent = espera;
            elements.requisicoesAprovadas.textContent = aprovadas;
            elements.requisicoesEntregues.textContent = entregues;
            elements.requisicoesNegadas.textContent = negadas;
        }

        function previousPage() {
            if (state.currentPage > 1) {
                state.currentPage--;
                updateRastreabilidadeTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(state.filteredRequests.length / state.itemsPerPage);
            if (state.currentPage < totalPages) {
                state.currentPage++;
                updateRastreabilidadeTable();
            }
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Cabeçalho do PDF
            doc.setFontSize(16);
            doc.text('Relatório de Rastreabilidade - Sistema de Requisições', 14, 15);
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 22);
            doc.text(`Usuário: ${state.currentUser.email}`, 14, 28);

            // Dados para a tabela
            const tableData = state.filteredRequests.map(request => [
                request.id.substring(0, 8) + '...',
                request.requisitante,
                request.setor,
                request.material,
                request.quantidade.toString(),
                request.data,
                getStatusText(request.status)
            ]);

            // Criar tabela
            doc.autoTable({
                startY: 35,
                head: [['ID', 'Requisitante', 'Setor', 'Material', 'Qtd', 'Data', 'Status']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Adicionar histórico detalhado
            let yPosition = doc.lastAutoTable.finalY + 10;
            
            state.filteredRequests.forEach((request, index) => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`Requisição: ${request.material} (ID: ${request.id.substring(0, 8)}...)`, 14, yPosition);
                yPosition += 6;
                
                doc.setFontSize(8);
                if (request.historico && request.historico.length > 0) {
                    request.historico.forEach(historico => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        let texto = `${historico.data} - ${getAcaoTexto(historico.acao)} por ${historico.nomeUsuario || historico.usuario}`;
                        if (historico.motivo) {
                            texto += ` - Motivo: ${historico.motivo}`;
                        }
                        
                        doc.text(texto, 20, yPosition);
                        yPosition += 4;
                    });
                }
                
                yPosition += 6;
            });

            // Estatísticas no final
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFontSize(10);
            doc.text(`Total de Requisições: ${state.filteredRequests.length}`, 14, yPosition);
            doc.text(`Pendentes: ${state.filteredRequests.filter(req => req.status === 'pendente').length}`, 14, yPosition + 6);
            doc.text(`Em Espera: ${state.filteredRequests.filter(req => req.status === 'espera').length}`, 14, yPosition + 12);
            doc.text(`Aprovadas: ${state.filteredRequests.filter(req => req.status === 'aprovado').length}`, 14, yPosition + 18);
            doc.text(`Entregues: ${state.filteredRequests.filter(req => req.status === 'entregue').length}`, 14, yPosition + 24);
            doc.text(`Negadas: ${state.filteredRequests.filter(req => req.status === 'negado').length}`, 14, yPosition + 30);

            // Salvar PDF
            doc.save(`rastreabilidade-requisicoes-${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function getAcaoTexto(acao) {
            const acoes = {
                'requisicao_aberta': 'Requisição aberta',
                'requisicao_aprovada': 'Requisição aprovada',
                'requisicao_negada': 'Requisição negada',
                'requisicao_em_espera': 'Requisição em espera',
                'requisicao_entregue': 'Material entregue',
                'requisicao_reaberta': 'Requisição reaberta'
            };
            return acoes[acao] || acao;
        }

        function showHistoryModal(requestId) {
            const request = state.requests.find(req => req.id === requestId);
            if (!request) return;
            
            elements.historyContent.innerHTML = `
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-2">Detalhes da Requisição</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div><span class="font-medium">Material:</span> ${request.material}</div>
                        <div><span class="font-medium">Requisitante:</span> ${request.requisitante}</div>
                        <div><span class="font-medium">Setor:</span> ${request.setor}</div>
                        <div><span class="font-medium">Quantidade:</span> ${request.quantidade}</div>
                        <div><span class="font-medium">Status:</span> <span class="status-badge ${getStatusClass(request.status)} text-xs py-1 px-2 rounded-full">${getStatusText(request.status)}</span></div>
                        <div><span class="font-medium">Data de abertura:</span> ${request.data}</div>
                    </div>
                    ${request.observacoes ? `
                    <div class="mt-2">
                        <span class="font-medium">Observações:</span>
                        <p class="text-sm mt-1">${request.observacoes}</p>
                    </div>
                    ` : ''}
                </div>
                
                <h4 class="font-bold text-gray-800 mb-3">Histórico de Ações</h4>
                <div class="space-y-3">
                    ${request.historico && request.historico.length > 0 
                        ? request.historico.map(historico => `
                            <div class="border-l-4 ${getHistoryBorderColor(historico.acao)} pl-4 py-2">
                                <div class="flex justify-between items-start">
                                    <div class="font-medium text-gray-800">${getAcaoTexto(historico.acao)}</div>
                                    <div class="text-xs text-gray-500">${historico.data}</div>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    Por: ${historico.nomeUsuario || historico.usuario}
                                    ${historico.motivo ? `<div class="mt-1 ${getHistoryTextColor(historico.acao)}"><strong>Motivo:</strong> ${historico.motivo}</div>` : ''}
                                    ${historico.detalhes && !historico.motivo ? `<div class="mt-1">${historico.detalhes}</div>` : ''}
                                </div>
                            </div>
                        `).join('')
                        : '<p class="text-gray-500 text-center py-4">Nenhum histórico disponível</p>'
                    }
                </div>
            `;
            
            elements.historyModal.classList.remove('hidden');
        }

        function getHistoryBorderColor(acao) {
            switch(acao) {
                case 'requisicao_negada': return 'border-red-500';
                case 'requisicao_em_espera': return 'border-purple-500';
                case 'requisicao_aprovada': return 'border-green-500';
                case 'requisicao_entregue': return 'border-blue-500';
                default: return 'border-gray-500';
            }
        }

        function getHistoryTextColor(acao) {
            switch(acao) {
                case 'requisicao_negada': return 'text-red-600';
                case 'requisicao_em_espera': return 'text-purple-600';
                default: return 'text-gray-600';
            }
        }

        function hideHistoryModal() {
            elements.historyModal.classList.add('hidden');
        }

        function showConfirmationModal(message, confirmCallback) {
            elements.confirmationMessage.textContent = message;
            elements.confirmationModal.classList.remove('hidden');
            
            // Remover event listeners anteriores
            elements.confirmAction.replaceWith(elements.confirmAction.cloneNode(true));
            elements.confirmAction = document.getElementById('confirm-action');
            
            // Adicionar novo event listener
            elements.confirmAction.addEventListener('click', function() {
                confirmCallback();
                hideConfirmationModal();
            });
        }

        function hideConfirmationModal() {
            elements.confirmationModal.classList.add('hidden');
        }

        function showDenyReasonModal(requestId) {
            state.currentDenyRequestId = requestId;
            elements.denyReasonInput.value = '';
            elements.denyReasonModal.classList.remove('hidden');
        }

        function hideDenyReasonModal() {
            elements.denyReasonModal.classList.add('hidden');
            state.currentDenyRequestId = null;
        }

        async function handleConfirmDeny() {
            const motivo = elements.denyReasonInput.value.trim();
            if (!motivo) {
                alert('Por favor, informe o motivo da negação.');
                return;
            }

            try {
                const request = state.requests.find(req => req.id === state.currentDenyRequestId);
                if (!request) return;
                
                const novoHistorico = [
                    ...request.historico,
                    {
                        acao: 'requisicao_negada',
                        usuario: state.currentUser.email,
                        nomeUsuario: state.currentUser.displayName || state.currentUser.email.split('@')[0],
                        data: new Date().toLocaleString('pt-BR'),
                        timestamp: new Date(),
                        detalhes: 'Requisição negada',
                        motivo: motivo,
                        vista: false
                    }
                ];
                
                const requestRef = window.firebase.doc(window.firebase.db, "requisicoes", state.currentDenyRequestId);
                await window.firebase.updateDoc(requestRef, {
                    status: 'negado',
                    historico: novoHistorico
                });
                
                hideDenyReasonModal();
                
                // Forçar atualização imediata
                setTimeout(() => {
                    forceRefreshData();
                }, 500);
                
            } catch (error) {
                console.error('Erro ao negar requisição:', error);
                alert('Erro ao negar requisição. Tente novamente.');
            }
        }

        // Função de toast para feedback
        function showToast(message, type = 'info') {
            const existingToast = document.getElementById('global-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.id = 'global-toast';
            toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white max-w-sm transform transition-transform duration-300 ${
                type === 'success' ? 'bg-success' : 
                type === 'error' ? 'bg-danger' : 
                type === 'warning' ? 'bg-warning' :
                'bg-primary'
            }`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('translate-x-0');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-x-0');
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Funções auxiliares
        function getStatusClass(status) {
            switch(status) {
                case 'pendente': return 'bg-warning text-white';
                case 'espera': return 'bg-info text-white';
                case 'aprovado': return 'bg-primary text-white';
                case 'entregue': return 'bg-success text-white';
                case 'negado': return 'bg-danger text-white';
                default: return 'bg-gray-200 text-gray-700';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'pendente': return 'Pendente';
                case 'espera': return 'Em Espera';
                case 'aprovado': return 'Aprovado';
                case 'entregue': return 'Entregue';
                case 'negado': return 'Negado';
                default: return status;
            }
        }
    </script>
</body>
</html>